<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤äº’å¼è§‚æœˆåŠ©æ‰‹</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ä¸æ˜Ÿç©ºèƒŒæ™¯ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #000;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            overflow-x: hidden;
            text-align: center;
            user-select: none;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent),
                radial-gradient(1px 1px at 80% 10%, white, transparent),
                radial-gradient(2px 2px at 90% 60%, white, transparent);
            background-size: 300px 300px;
            animation: twinkle 10s infinite;
            opacity: 0.8;
            z-index: -1;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.3; }
        }

        /* --- ä¸»å¡ç‰‡å®¹å™¨ --- */
        .container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 15px 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 500px;
            width: 100%;
            z-index: 1;
            position: relative;
            box-sizing: border-box;
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- 3D æœˆäº®å®¹å™¨ --- */
        .moon-3d-container {
            width: 220px;
            height: 220px;
            margin: 10px auto;
            perspective: 1000px;
            cursor: grab;
            position: relative;
        }

        .moon-3d-container:active {
            cursor: grabbing;
        }

        #moon-svg {
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
            filter: drop-shadow(0 0 30px rgba(255, 255, 200, 0.8))
                    drop-shadow(0 0 60px rgba(255, 255, 200, 0.4))
                    drop-shadow(-8px -8px 15px rgba(0, 0, 0, 0.8));
            animation: moonGlow 4s ease-in-out infinite alternate;
        }

        @keyframes moonGlow {
            0% { 
                filter: drop-shadow(0 0 30px rgba(255, 255, 200, 0.8))
                       drop-shadow(0 0 60px rgba(255, 255, 200, 0.4))
                       drop-shadow(-8px -8px 15px rgba(0, 0, 0, 0.8));
            }
            100% { 
                filter: drop-shadow(0 0 40px rgba(255, 255, 200, 1))
                       drop-shadow(0 0 80px rgba(255, 255, 200, 0.6))
                       drop-shadow(-8px -8px 20px rgba(0, 0, 0, 0.9));
            }
        }

        /* --- ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ --- */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85em;
            text-align: left;
            margin-top: 10px;
        }

        .info-grid p {
            margin: 3px 0;
            background: rgba(255, 255, 255, 0.03);
            padding: 6px;
            border-radius: 6px;
        }

        .info-grid p strong {
            color: #a5d8ff;
            display: block;
            margin-bottom: 2px;
            font-size: 0.9em;
        }

        /* --- çŠ¶æ€æ¶ˆæ¯æ ·å¼ --- */
        #status-message {
            color: #f0ad4e;
            font-style: italic;
            min-height: 15px;
            margin-top: 8px;
            font-size: 0.85em;
        }
        .error { color: #e57373; font-weight: bold; }

        /* --- è¯­è¨€é€‰æ‹©å™¨ä¼˜åŒ– --- */
        .language-selector {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 35px;
            height: 35px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .language-selector:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .language-dropdown {
            position: fixed;
            top: 60px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 8px 0;
            display: none;
            z-index: 100;
            min-width: 140px;
            backdrop-filter: blur(10px);
        }

        .language-dropdown.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .language-option {
            padding: 8px 12px;
            cursor: pointer;
            text-align: left;
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }

        .language-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .language-flag {
            margin-right: 8px;
            font-size: 16px;
        }

        .language-name {
            flex: 1;
        }

        .language-code {
            font-size: 11px;
            color: #aaa;
        }

        /* --- æœˆäº®å…‰æ™•æ•ˆæœ --- */
        .moon-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 260px;
            height: 260px;
            background: radial-gradient(circle, 
                rgba(255, 255, 200, 0.1) 0%, 
                rgba(255, 255, 200, 0.05) 30%, 
                transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            animation: glowPulse 3s ease-in-out infinite;
        }

        @keyframes glowPulse {
            0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        }

        /* --- æ˜Ÿæ˜Ÿé—ªçƒæ•ˆæœ --- */
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkleStar 2s infinite;
        }

        @keyframes twinkleStar {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="app-title">ğŸŒ™ äº¤äº’å¼è§‚æœˆåŠ©æ‰‹</h1>
        
        <div class="moon-3d-container" id="moon-container">
            <div class="moon-glow"></div>
            <div id="moon-svg-container"></div>
        </div>

        <div class="info-grid">
            <p><strong id="phase-name-label">æœˆç›¸åç§°</strong><span id="phase-name">è®¡ç®—ä¸­...</span></p>
            <p><strong id="illumination-label">è¢«ç…§äº®æ¯”ä¾‹</strong><span id="illumination">0%</span></p>
            <p><strong id="location-label">ğŸ“ ä½ç½®</strong><span id="location">è·å–ä¸­...</span></p>
            <p><strong id="current-time-label">ğŸ• æ—¶é—´</strong><span id="current-time">--</span></p>
            <p><strong id="moonrise-label">ğŸŒ… æœˆå‡ºæ—¶é—´</strong><span id="moonrise">--:--</span></p>
            <p><strong id="moonset-label">ğŸŒ‡ æœˆè½æ—¶é—´</strong><span id="moonset">--:--</span></p>
            <p><strong id="tomorrow-moonrise-label">ğŸŒ… æ˜æ—¥æœˆå‡ºæ—¶é—´</strong><span id="tomorrow-moonrise">--:--</span></p>
            <p><strong id="tomorrow-moonset-label">ğŸŒ‡ æ˜æ—¥æœˆè½æ—¶é—´</strong><span id="tomorrow-moonset">--:--</span></p>
            <p><strong id="sky-position-label">ğŸŒŒ å¤©ç©ºä½ç½®</strong><span id="sky-position">--</span></p>
        </div>

        <p id="status-message">æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...</p>
    </div>

    <!-- è¯­è¨€é€‰æ‹©å™¨ -->
    <div class="language-selector" id="language-selector">ğŸŒ</div>
    <div class="language-dropdown" id="language-dropdown">
        <div class="language-option" data-lang="zh-CN">
            <span class="language-flag">ğŸ‡¨ğŸ‡³</span>
            <span class="language-name">ä¸­æ–‡</span>
            <span class="language-code">zh-CN</span>
        </div>
        <div class="language-option" data-lang="en">
            <span class="language-flag">ğŸ‡ºğŸ‡¸</span>
            <span class="language-name">English</span>
            <span class="language-code">en</span>
        </div>
        <div class="language-option" data-lang="ja">
            <span class="language-flag">ğŸ‡¯ğŸ‡µ</span>
            <span class="language-name">æ—¥æœ¬èª</span>
            <span class="language-code">ja</span>
        </div>
        <div class="language-option" data-lang="es">
            <span class="language-flag">ğŸ‡ªğŸ‡¸</span>
            <span class="language-name">EspaÃ±ol</span>
            <span class="language-code">es</span>
        </div>
        <div class="language-option" data-lang="fr">
            <span class="language-flag">ğŸ‡«ğŸ‡·</span>
            <span class="language-name">FranÃ§ais</span>
            <span class="language-code">fr</span>
        </div>
    </div>

    <script>
        // --- å¤šè¯­è¨€æ”¯æŒ ---
        const translations = {
            'zh-CN': {
                title: 'ğŸŒ™ äº¤äº’å¼è§‚æœˆåŠ©æ‰‹',
                phaseName: 'æœˆç›¸åç§°',
                illumination: 'è¢«ç…§äº®æ¯”ä¾‹',
                location: 'ğŸ“ ä½ç½®',
                currentTime: 'ğŸ• æ—¶é—´',
                moonrise: 'ğŸŒ… æœˆå‡ºæ—¶é—´',
                moonset: 'ğŸŒ‡ æœˆè½æ—¶é—´',
                tomorrowMoonrise: 'ğŸŒ… æ˜æ—¥æœˆå‡ºæ—¶é—´',
                tomorrowMoonset: 'ğŸŒ‡ æ˜æ—¥æœˆè½æ—¶é—´',
                skyPosition: 'ğŸŒŒ å¤©ç©ºä½ç½®',
                gettingLocation: 'æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...',
                locationError: 'æ— æ³•è·å–æ‚¨çš„ä½ç½®ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚',
                browserNotSupported: 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½ã€‚',
                calculating: 'è®¡ç®—ä¸­...',
                noRise: 'ä»Šæ—¥ä¸å‡èµ·',
                noSet: 'ä»Šæ—¥ä¸è½ä¸‹',
                north: 'åŒ—',
                northeast: 'ä¸œåŒ—',
                east: 'ä¸œ',
                southeast: 'ä¸œå—',
                south: 'å—',
                southwest: 'è¥¿å—',
                west: 'è¥¿',
                northwest: 'è¥¿åŒ—',
                high: 'é«˜ç©º',
                medium: 'ä¸­ç©º',
                low: 'ä½ç©º',
                belowHorizon: 'åœ°å¹³çº¿ä¸‹',
                phases: {
                    new: 'ğŸŒ‘ æ–°æœˆ',
                    waxingCrescent: 'ğŸŒ’ è›¾çœ‰æœˆ',
                    firstQuarter: 'ğŸŒ“ ä¸Šå¼¦æœˆ',
                    waxingGibbous: 'ğŸŒ” ç›ˆå‡¸æœˆ',
                    full: 'ğŸŒ• æ»¡æœˆ',
                    waningGibbous: 'ğŸŒ– äºå‡¸æœˆ',
                    lastQuarter: 'ğŸŒ— ä¸‹å¼¦æœˆ',
                    waningCrescent: 'ğŸŒ˜ æ®‹æœˆ'
                }
            },
            'en': {
                title: 'ğŸŒ™ Interactive Moon Observer',
                phaseName: 'Moon Phase',
                illumination: 'Illumination',
                location: 'ğŸ“ Location',
                currentTime: 'ğŸ• Time',
                moonrise: 'ğŸŒ… Moonrise',
                moonset: 'ğŸŒ‡ Moonset',
                tomorrowMoonrise: 'ğŸŒ… Tomorrow Moonrise',
                tomorrowMoonset: 'ğŸŒ‡ Tomorrow Moonset',
                skyPosition: 'ğŸŒŒ Sky Position',
                gettingLocation: 'Getting your location...',
                locationError: 'Unable to get your location, please check browser permissions.',
                browserNotSupported: 'Your browser does not support geolocation.',
                calculating: 'Calculating...',
                noRise: 'No rise today',
                noSet: 'No set today',
                north: 'North',
                northeast: 'Northeast',
                east: 'East',
                southeast: 'Southeast',
                south: 'South',
                southwest: 'Southwest',
                west: 'West',
                northwest: 'Northwest',
                high: 'High',
                medium: 'Medium',
                low: 'Low',
                belowHorizon: 'Below horizon',
                phases: {
                    new: 'ğŸŒ‘ New Moon',
                    waxingCrescent: 'ğŸŒ’ Waxing Crescent',
                    firstQuarter: 'ğŸŒ“ First Quarter',
                    waxingGibbous: 'ğŸŒ” Waxing Gibbous',
                    full: 'ğŸŒ• Full Moon',
                    waningGibbous: 'ğŸŒ– Waning Gibbous',
                    lastQuarter: 'ğŸŒ— Last Quarter',
                    waningCrescent: 'ğŸŒ˜ Waning Crescent'
                }
            },
            'ja': {
                title: 'ğŸŒ™ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–æœˆè¦³æ¸¬ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ',
                phaseName: 'æœˆã®æº€ã¡æ¬ ã‘',
                illumination: 'ç…§æ˜ç‡',
                location: 'ğŸ“ ä½ç½®',
                currentTime: 'ğŸ• æ™‚é–“',
                moonrise: 'ğŸŒ… æœˆã®å‡º',
                moonset: 'ğŸŒ‡ æœˆã®å…¥ã‚Š',
                tomorrowMoonrise: 'ğŸŒ… æ˜æ—¥ã®æœˆã®å‡º',
                tomorrowMoonset: 'ğŸŒ‡ æ˜æ—¥ã®æœˆã®å…¥ã‚Š',
                skyPosition: 'ğŸŒŒ ç©ºã®ä½ç½®',
                gettingLocation: 'ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...',
                locationError: 'ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
                browserNotSupported: 'ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯åœ°ç†ä½ç½®æƒ…å ±æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚',
                calculating: 'è¨ˆç®—ä¸­...',
                noRise: 'ä»Šæ—¥ã¯æœˆã®å‡ºãªã—',
                noSet: 'ä»Šæ—¥ã¯æœˆã®å…¥ã‚Šãªã—',
                north: 'åŒ—',
                northeast: 'åŒ—æ±',
                east: 'æ±',
                southeast: 'å—æ±',
                south: 'å—',
                southwest: 'å—è¥¿',
                west: 'è¥¿',
                northwest: 'åŒ—è¥¿',
                high: 'é«˜ç©º',
                medium: 'ä¸­ç©º',
                low: 'ä½ç©º',
                belowHorizon: 'åœ°å¹³ç·šä¸‹',
                phases: {
                    new: 'ğŸŒ‘ æ–°æœˆ',
                    waxingCrescent: 'ğŸŒ’ ä¸‰æ—¥æœˆ',
                    firstQuarter: 'ğŸŒ“ ä¸Šå¼¦ã®æœˆ',
                    waxingGibbous: 'ğŸŒ” åä¸‰å¤œæœˆ',
                    full: 'ğŸŒ• æº€æœˆ',
                    waningGibbous: 'ğŸŒ– åå…­å¤œæœˆ',
                    lastQuarter: 'ğŸŒ— ä¸‹å¼¦ã®æœˆ',
                    waningCrescent: 'ğŸŒ˜ æœ‰æ˜ã®æœˆ'
                }
            },
            'es': {
                title: 'ğŸŒ™ Asistente Interactivo de ObservaciÃ³n Lunar',
                phaseName: 'Fase Lunar',
                illumination: 'IluminaciÃ³n',
                location: 'ğŸ“ UbicaciÃ³n',
                currentTime: 'ğŸ• Hora',
                moonrise: 'ğŸŒ… Salida de la Luna',
                moonset: 'ğŸŒ‡ Puesta de la Luna',
                tomorrowMoonrise: 'ğŸŒ… Salida de Luna MaÃ±ana',
                tomorrowMoonset: 'ğŸŒ‡ Puesta de Luna MaÃ±ana',
                skyPosition: 'ğŸŒŒ PosiciÃ³n en el Cielo',
                gettingLocation: 'Obteniendo tu ubicaciÃ³n...',
                locationError: 'No se puede obtener tu ubicaciÃ³n, verifica los permisos del navegador.',
                browserNotSupported: 'Tu navegador no soporta geolocalizaciÃ³n.',
                calculating: 'Calculando...',
                noRise: 'No sale hoy',
                noSet: 'No se pone hoy',
                north: 'Norte',
                northeast: 'Noreste',
                east: 'Este',
                southeast: 'Sureste',
                south: 'Sur',
                southwest: 'Suroeste',
                west: 'Oeste',
                northwest: 'Noroeste',
                high: 'Alto',
                medium: 'Medio',
                low: 'Bajo',
                belowHorizon: 'Bajo el horizonte',
                phases: {
                    new: 'ğŸŒ‘ Luna Nueva',
                    waxingCrescent: 'ğŸŒ’ Luna Creciente',
                    firstQuarter: 'ğŸŒ“ Cuarto Creciente',
                    waxingGibbous: 'ğŸŒ” Luna Gibosa Creciente',
                    full: 'ğŸŒ• Luna Llena',
                    waningGibbous: 'ğŸŒ– Luna Gibosa Menguante',
                    lastQuarter: 'ğŸŒ— Cuarto Menguante',
                    waningCrescent: 'ğŸŒ˜ Luna Menguante'
                }
            },
            'fr': {
                title: 'ğŸŒ™ Assistant d\'Observation Lunaire Interactif',
                phaseName: 'Phase Lunaire',
                illumination: 'Illumination',
                location: 'ğŸ“ Emplacement',
                currentTime: 'ğŸ• Heure',
                moonrise: 'ğŸŒ… Lever de la Lune',
                moonset: 'ğŸŒ‡ Coucher de la Lune',
                tomorrowMoonrise: 'ğŸŒ… Lever de Lune Demain',
                tomorrowMoonset: 'ğŸŒ‡ Coucher de Lune Demain',
                skyPosition: 'ğŸŒŒ Position dans le Ciel',
                gettingLocation: 'Obtention de votre position...',
                locationError: 'Impossible d\'obtenir votre position, vÃ©rifiez les autorisations du navigateur.',
                browserNotSupported: 'Votre navigateur ne supporte pas la gÃ©olocalisation.',
                calculating: 'Calcul en cours...',
                noRise: 'Pas de lever aujourd\'hui',
                noSet: 'Pas de coucher aujourd\'hui',
                north: 'Nord',
                northeast: 'Nord-Est',
                east: 'Est',
                southeast: 'Sud-Est',
                south: 'Sud',
                southwest: 'Sud-Ouest',
                west: 'Ouest',
                northwest: 'Nord-Ouest',
                high: 'Ã‰levÃ©',
                medium: 'Moyen',
                low: 'Bas',
                belowHorizon: 'Sous l\'horizon',
                phases: {
                    new: 'ğŸŒ‘ Nouvelle Lune',
                    waxingCrescent: 'ğŸŒ’ Premier Croissant',
                    firstQuarter: 'ğŸŒ“ Premier Quartier',
                    waxingGibbous: 'ğŸŒ” Lune Gibbeuse Croissante',
                    full: 'ğŸŒ• Pleine Lune',
                    waningGibbous: 'ğŸŒ– Lune Gibbeuse DÃ©croissante',
                    lastQuarter: 'ğŸŒ— Dernier Quartier',
                    waningCrescent: 'ğŸŒ˜ Dernier Croissant'
                }
            }
        };

        // å½“å‰è¯­è¨€
        let currentLang = 'zh-CN';

        // --- DOM å…ƒç´ å¼•ç”¨ ---
        const moonSvgContainer = document.getElementById('moon-svg-container');
        const moonContainer = document.getElementById('moon-container');
        const phaseNameEl = document.getElementById('phase-name');
        const illuminationEl = document.getElementById('illumination');
        const locationEl = document.getElementById('location');
        const currentTimeEl = document.getElementById('current-time');
        const moonriseEl = document.getElementById('moonrise');
        const moonsetEl = document.getElementById('moonset');
        const tomorrowMoonriseEl = document.getElementById('tomorrow-moonrise');
        const tomorrowMoonsetEl = document.getElementById('tomorrow-moonset');
        const skyPositionEl = document.getElementById('sky-position');
        const statusMessageEl = document.getElementById('status-message');
        
        // è¯­è¨€åˆ‡æ¢ç›¸å…³å…ƒç´ 
        const languageSelector = document.getElementById('language-selector');
        const languageDropdown = document.getElementById('language-dropdown');
        const languageOptions = document.querySelectorAll('.language-option');

        let userCoords = null;
        let updateInterval = null;

        // --- äº¤äº’ç›¸å…³å˜é‡ ---
        let isDragging = false, currentRotationY = -25, currentRotationX = 10;
        let startX = 0, startY = 0, velocity = { x: 0, y: 0 };
        let lastMouseX = 0, lastMouseY = 0, animationFrameId = null;
        let startSound, endSound;

        // åˆå§‹åŒ–éŸ³é¢‘
        function initAudio() {
            try {
                startSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                endSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                startSound.volume = 0.3; 
                endSound.volume = 0.3;
            } catch (e) {
                console.log("éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:", e);
            }
        }

        // --- å¤©æ–‡è®¡ç®—è¾…åŠ©å‡½æ•° ---
        const toRad = (deg) => deg * (Math.PI / 180);
        const toDeg = (rad) => rad * (180 / Math.PI);

        // --- æ ¸å¿ƒæœˆç›¸è®¡ç®—å‡½æ•° ---
        function getMoonPhase(date) {
            const knownNewMoon = new Date(Date.UTC(2000, 0, 6, 18, 14));
            const synodicMonth = 29.530588853;
            const timeDiff = date - knownNewMoon;
            const daysDiff = timeDiff / (1000 * 60 * 60 * 24);
            let moonAge = (daysDiff % synodicMonth + synodicMonth) % synodicMonth;
            let illumination = 0.5 * (1 - Math.cos(2 * Math.PI * (moonAge / synodicMonth)));
            return { age: moonAge, illumination: illumination, phase: moonAge / synodicMonth };
        }

        function getPhaseName(age) {
            const t = translations[currentLang];
            if (age < 1.84) return t.phases.new; 
            if (age < 5.53) return t.phases.waxingCrescent; 
            if (age < 9.22) return t.phases.firstQuarter;
            if (age < 12.91) return t.phases.waxingGibbous; 
            if (age < 16.61) return t.phases.full; 
            if (age < 20.30) return t.phases.waningGibbous;
            if (age < 23.99) return t.phases.lastQuarter; 
            if (age < 27.68) return t.phases.waningCrescent; 
            return t.phases.new;
        }

        // --- æœˆäº®ä½ç½®è®¡ç®— ---
        function getMoonPosition(date, lat, lon) {
            const T = (date - new Date(Date.UTC(2000, 0, 1, 12, 0, 0))) / (365.25 * 86400000.0);
            
            const L_prime = toRad(218.3164477 + 481267.88123421 * T - 0.0015786 * T * T + T * T * T / 538841 - T * T * T * T / 65194000);
            const M_prime = toRad(134.9633964 + 477198.8675055 * T + 0.0087414 * T * T + T * T * T / 69699 - T * T * T * T / 14712000);
            const D = toRad(297.8501921 + 445267.1113532 * T - 0.0016300 * T * T + T * T * T / 545868 - T * T * T * T / 113065000);
            const M = toRad(357.5291092 + 35999.0502909 * T - 0.0001536 * T * T + T * T * T / 24490000);
            
            let E = 1 - 0.002516 * T - 0.0000074 * T * T;
            let lambda = L_prime + 22640 * Math.sin(M_prime) - 4586 * Math.sin(M_prime - 2*D) + 2370 * Math.sin(2*D) + 769 * Math.sin(2*M_prime) - 668 * Math.sin(M) - 412 * Math.sin(2*M_prime - 2*D) - 212 * Math.sin(2*M_prime + 2*D) - 206 * Math.sin(M_prime + M - 2*D) + 192 * Math.sin(M_prime - M) - 165 * Math.sin(D) + 148 * Math.sin(M_prime - M - 2*D) - 125 * Math.sin(D) - 110 * Math.sin(M_prime + M) - 55 * Math.sin(2*D - 2*M);
            let beta = 18520 * Math.sin(D + M_prime - 2*D) - 5260 * Math.sin(M_prime - 2*D) + 4400 * Math.sin(2*D) - 1600 * Math.sin(M_prime) + 1200 * Math.sin(M) - 600 * Math.sin(2*M_prime - 2*D);
            
            lambda = toRad(lambda);
            beta = toRad(beta);
            
            const epsilon = toRad(23.4392911 - 0.0130042 * T - 0.00000016 * T * T + 0.000000504 * T * T * T);
            
            const ra = Math.atan2(Math.cos(epsilon) * Math.sin(lambda) - Math.sin(epsilon) * Math.tan(beta), Math.cos(lambda));
            const dec = Math.asin(Math.sin(epsilon) * Math.sin(lambda) * Math.cos(beta) + Math.cos(epsilon) * Math.sin(beta));

            const lst = (18.697374558 + 24.06570982441908 * T) + (lon / 15.0);
            const ha = toRad((lst * 15) - toDeg(ra));
            
            const alt = Math.asin(Math.sin(dec) * Math.sin(toRad(lat)) + Math.cos(dec) * Math.cos(toRad(lat)) * Math.cos(ha));
            const az = Math.atan2(-Math.sin(ha), Math.tan(dec) * Math.cos(toRad(lat)) - Math.sin(toRad(lat)) * Math.cos(ha));
            
            return {
                altitude: toDeg(alt),
                azimuth: (toDeg(az) + 360) % 360
            };
        }
        
        // --- è®¡ç®—æœˆå‡ºæœˆè½ ---
        function getMoonRiseSet(date, lat, lon) {
            let moonrise = null, moonset = null;
            for (let dayOffset = -1; dayOffset <= 1; dayOffset++) {
                const checkDate = new Date(date);
                checkDate.setDate(checkDate.getDate() + dayOffset);
                checkDate.setHours(0, 0, 0, 0);

                let lastAlt = getMoonPosition(checkDate, lat, lon).altitude;
                let rising = false, setting = false;

                for (let h = 0; h < 24; h += 0.5) {
                    const currentTime = new Date(checkDate.getTime() + h * 3600 * 1000);
                    const currentAlt = getMoonPosition(currentTime, lat, lon).altitude;

                    if (lastAlt < 0 && currentAlt >= 0) {
                        if (!moonrise || currentTime < moonrise) moonrise = currentTime;
                    }
                    if (lastAlt >= 0 && currentAlt < 0) {
                        if (!moonset || currentTime < moonset) moonset = currentTime;
                    }
                    lastAlt = currentAlt;
                }
            }
            return { moonrise, moonset };
        }

        // --- è·å–å¤©ç©ºä½ç½®æè¿° ---
        function getSkyPosition(altitude, azimuth) {
            const t = translations[currentLang];
            
            // å¦‚æœæœˆäº®åœ¨åœ°å¹³çº¿ä¸‹
            if (altitude < 0) {
                return t.belowHorizon;
            }
            
            // ç¡®å®šé«˜åº¦æè¿°
            let heightDesc;
            if (altitude >= 60) {
                heightDesc = t.high;
            } else if (altitude >= 30) {
                heightDesc = t.medium;
            } else {
                heightDesc = t.low;
            }
            
            // ç¡®å®šæ–¹ä½æè¿°
            let directionDesc;
            if (azimuth >= 337.5 || azimuth < 22.5) {
                directionDesc = t.north;
            } else if (azimuth >= 22.5 && azimuth < 67.5) {
                directionDesc = t.northeast;
            } else if (azimuth >= 67.5 && azimuth < 112.5) {
                directionDesc = t.east;
            } else if (azimuth >= 112.5 && azimuth < 157.5) {
                directionDesc = t.southeast;
            } else if (azimuth >= 157.5 && azimuth < 202.5) {
                directionDesc = t.south;
            } else if (azimuth >= 202.5 && azimuth < 247.5) {
                directionDesc = t.southwest;
            } else if (azimuth >= 247.5 && azimuth < 292.5) {
                directionDesc = t.west;
            } else if (azimuth >= 292.5 && azimuth < 337.5) {
                directionDesc = t.northwest;
            }
            
            return `${directionDesc}${heightDesc}`;
        }

        // --- å¢å¼ºçš„æœˆç›¸SVGç»˜åˆ¶ ---
        function drawMoonPhase(illumination) {
            const size = 220; // ç¼©å°å°ºå¯¸
            const radius = size / 2;
            const isWaxing = illumination > 0.5;
            const shadowRadiusX = radius * Math.abs(2 * illumination - 1);
            const shadowTranslateX = isWaxing ? radius - shadowRadiusX : -(radius - shadowRadiusX);
            
            // æ›´å¤æ‚çš„æœˆäº®è¡¨é¢çº¹ç†
            const craters = [
                { x: 0.7, y: 0.5, r: 0.08, opacity: 0.6 },
                { x: 1.2, y: 1.3, r: 0.12, opacity: 0.5 },
                { x: 0.5, y: 1.5, r: 0.06, opacity: 0.4 },
                { x: 0.8, y: 0.6, r: 0.07, opacity: 0.7 },
                { x: 0.3, y: 1.2, r: 0.09, opacity: 0.6 },
                { x: 1.1, y: 0.8, r: 0.05, opacity: 0.5 },
                { x: 0.6, y: 0.9, r: 0.08, opacity: 0.4 },
                { x: 0.9, y: 1.1, r: 0.06, opacity: 0.6 }
            ];
            
            let craterElements = '';
            craters.forEach(crater => {
                craterElements += `<circle cx="${radius * crater.x}" cy="${radius * crater.y}" r="${radius * crater.r}" fill="#2a2a2a" opacity="${crater.opacity}"/>`;
            });
            
            // æ›´æ˜äº®çš„é«˜å…‰æ•ˆæœ
            const highlights = [
                { x: 0.65, y: 0.45, r: 0.1, opacity: 0.7 },
                { x: 1.15, y: 1.25, r: 0.15, opacity: 0.6 },
                { x: 0.45, y: 1.45, r: 0.08, opacity: 0.5 }
            ];
            
            let highlightElements = '';
            highlights.forEach(highlight => {
                highlightElements += `<circle cx="${radius * highlight.x}" cy="${radius * highlight.y}" r="${radius * highlight.r}" fill="#e8e4d6" opacity="${highlight.opacity}" mask="url(#moon-mask)"/>`;
            });
            
            const svg = `
                <svg id="moon-svg" width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <mask id="moon-mask">
                            <rect width="100%" height="100%" fill="white"/>
                            <ellipse cx="${radius + shadowTranslateX}" cy="${radius}" rx="${shadowRadiusX}" ry="${radius}" fill="black"/>
                        </mask>
                        <radialGradient id="moonGradient">
                            <stop offset="0%" style="stop-color:#f8f4e6;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#e8d4a0;stop-opacity:1" />
                        </radialGradient>
                        <radialGradient id="shadowGradient">
                            <stop offset="0%" style="stop-color:#3a3a3a;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#1a1a1a;stop-opacity:1" />
                        </radialGradient>
                    </defs>
                    <!-- æœˆäº®åŸºç¡€ -->
                    <circle cx="${radius}" cy="${radius}" r="${radius - 3}" fill="url(#shadowGradient)"/>
                    <circle cx="${radius}" cy="${radius}" r="${radius - 3}" fill="url(#moonGradient)" mask="url(#moon-mask)"/>
                    <!-- è¡¨é¢ç»†èŠ‚ -->
                    ${craterElements}
                    <!-- é«˜å…‰æ•ˆæœ -->
                    ${highlightElements}
                    <!-- è¾¹ç¼˜å…‰æ™• -->
                    <circle cx="${radius}" cy="${radius}" r="${radius - 3}" fill="none" stroke="rgba(255,255,200,0.2)" stroke-width="2" mask="url(#moon-mask)"/>
                </svg>
            `;
            
            moonSvgContainer.innerHTML = svg; 
            applyRotation();
        }

        function applyRotation() { 
            const moonSvg = document.getElementById('moon-svg'); 
            if (moonSvg) { 
                moonSvg.style.transform = `rotateY(${currentRotationY}deg) rotateX(${currentRotationX}deg)`; 
            } 
        }

        function inertiaAnimation() { 
            if (!isDragging) { 
                currentRotationY += velocity.x; 
                currentRotationX -= velocity.y; 
                velocity.x *= 0.95; 
                velocity.y *= 0.95; 
                applyRotation(); 
                if (Math.abs(velocity.x) > 0.01 || Math.abs(velocity.y) > 0.01) { 
                    animationFrameId = requestAnimationFrame(inertiaAnimation); 
                } 
            } 
        }

        function handleStart(e) { 
            isDragging = true; 
            startX = (e.clientX || e.touches[0].clientX); 
            startY = (e.clientY || e.touches[0].clientY); 
            lastMouseX = startX; 
            lastMouseY = startY; 
            velocity = { x: 0, y: 0 }; 
            if (animationFrameId) cancelAnimationFrame(animationFrameId); 
            if (startSound) {
                startSound.currentTime = 0; 
                startSound.play().catch(e => console.log("Sound play failed:", e));
            }
        }

        function handleMove(e) { 
            if (!isDragging) return; 
            e.preventDefault(); 
            const clientX = e.clientX || e.touches[0].clientX; 
            const clientY = e.clientY || e.touches[0].clientY; 
            const deltaX = clientX - lastMouseX; 
            const deltaY = clientY - lastMouseY; 
            velocity.x = deltaX * 0.5; 
            velocity.y = deltaY * 0.5; 
            currentRotationY += deltaX; 
            currentRotationX -= deltaY; 
            applyRotation(); 
            lastMouseX = clientX; 
            lastMouseY = clientY; 
        }

        function handleEnd(e) { 
            if (!isDragging) return; 
            isDragging = false; 
            if (endSound) {
                endSound.currentTime = 0; 
                endSound.play().catch(e => console.log("Sound play failed:", e));
            }
            inertiaAnimation(); 
        }

        // --- æ›´æ–°ç•Œé¢è¯­è¨€ ---
        function updateLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            
            document.getElementById('app-title').textContent = t.title;
            document.getElementById('phase-name-label').textContent = t.phaseName;
            document.getElementById('illumination-label').textContent = t.illumination;
            document.getElementById('location-label').textContent = t.location;
            document.getElementById('current-time-label').textContent = t.currentTime;
            document.getElementById('moonrise-label').textContent = t.moonrise;
            document.getElementById('moonset-label').textContent = t.moonset;
            document.getElementById('tomorrow-moonrise-label').textContent = t.tomorrowMoonrise;
            document.getElementById('tomorrow-moonset-label').textContent = t.tomorrowMoonset;
            document.getElementById('sky-position-label').textContent = t.skyPosition;
            
            // æ›´æ–°å½“å‰æ˜¾ç¤ºçš„å†…å®¹
            if (userCoords) {
                updateDisplay();
            }
        }

        // --- æ›´æ–°æ‰€æœ‰æ˜¾ç¤ºä¿¡æ¯ ---
        function updateDisplay() {
            if (!userCoords) { 
                const t = translations[currentLang];
                statusMessageEl.textContent = t.locationError; 
                statusMessageEl.classList.add('error'); 
                return; 
            }
            
            const now = new Date();
            const t = translations[currentLang];
            
            // ä½¿ç”¨å½“å‰è¯­è¨€çš„æ—¥æœŸæ—¶é—´æ ¼å¼
            if (currentLang === 'zh-CN') {
                currentTimeEl.textContent = now.toLocaleString('zh-CN', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: false 
                });
            } else if (currentLang === 'ja') {
                currentTimeEl.textContent = now.toLocaleString('ja-JP', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: false 
                });
            } else {
                currentTimeEl.textContent = now.toLocaleString('en-US', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: false 
                });
            }
            
            const moonData = getMoonPhase(now);
            phaseNameEl.textContent = getPhaseName(moonData.age);
            illuminationEl.textContent = `${(moonData.illumination * 100).toFixed(1)}%`;
            
            if (!document.getElementById('moon-svg')) {
                drawMoonPhase(moonData.illumination);
            }

            // æ›´æ–°ä½ç½®ä¿¡æ¯
            const pos = getMoonPosition(now, userCoords.latitude, userCoords.longitude);
            
            // æ›´æ–°å¤©ç©ºä½ç½®æè¿°
            skyPositionEl.textContent = getSkyPosition(pos.altitude, pos.azimuth);

            // è®¡ç®—å¹¶æ˜¾ç¤ºä»Šæ—¥æœˆå‡ºæœˆè½
            const { moonrise, moonset } = getMoonRiseSet(now, userCoords.latitude, userCoords.longitude);
            moonriseEl.textContent = moonrise ? moonrise.toLocaleTimeString(currentLang === 'zh-CN' ? 'zh-CN' : currentLang === 'ja' ? 'ja-JP' : 'en-US', { hour: '2-digit', minute: '2-digit' }) : t.noRise;
            moonsetEl.textContent = moonset ? moonset.toLocaleTimeString(currentLang === 'zh-CN' ? 'zh-CN' : currentLang === 'ja' ? 'ja-JP' : 'en-US', { hour: '2-digit', minute: '2-digit' }) : t.noSet;

            // è®¡ç®—å¹¶æ˜¾ç¤ºæ˜æ—¥æœˆå‡ºæœˆè½
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const { moonrise: tomorrowMoonrise, moonset: tomorrowMoonset } = getMoonRiseSet(tomorrow, userCoords.latitude, userCoords.longitude);
            tomorrowMoonriseEl.textContent = tomorrowMoonrise ? tomorrowMoonrise.toLocaleTimeString(currentLang === 'zh-CN' ? 'zh-CN' : currentLang === 'ja' ? 'ja-JP' : 'en-US', { hour: '2-digit', minute: '2-digit' }) : t.noRise;
            tomorrowMoonsetEl.textContent = tomorrowMoonset ? tomorrowMoonset.toLocaleTimeString(currentLang === 'zh-CN' ? 'zh-CN' : currentLang === 'ja' ? 'ja-JP' : 'en-US', { hour: '2-digit', minute: '2-digit' }) : t.noSet;

            statusMessageEl.textContent = ''; 
            statusMessageEl.classList.remove('error');
        }

        // --- è·å–åœ°ç†ä½ç½® ---
        function getLocation() {
            const t = translations[currentLang];
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userCoords = { 
                            latitude: position.coords.latitude, 
                            longitude: position.coords.longitude
                        };
                        locationEl.textContent = `${userCoords.latitude.toFixed(2)}Â°N, ${userCoords.longitude.toFixed(2)}Â°E`;
                        
                        // å¯åŠ¨å®æ—¶æ›´æ–°
                        if (updateInterval) clearInterval(updateInterval);
                        updateInterval = setInterval(updateDisplay, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼Œç¡®ä¿æ—¶é—´è¯»ç§’
                        updateDisplay(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
                    },
                    (error) => { 
                        statusMessageEl.textContent = t.locationError; 
                        statusMessageEl.classList.add('error'); 
                        locationEl.textContent = "æœªçŸ¥"; 
                    }
                );
            } else { 
                statusMessageEl.textContent = t.browserNotSupported; 
                statusMessageEl.classList.add('error'); 
                locationEl.textContent = "ä¸æ”¯æŒ"; 
            }
        }

        // --- è¯­è¨€åˆ‡æ¢åŠŸèƒ½ ---
        function setupLanguageSelector() {
            languageSelector.addEventListener('click', () => {
                languageDropdown.classList.toggle('show');
            });
            
            document.addEventListener('click', (e) => {
                if (!languageSelector.contains(e.target) && !languageDropdown.contains(e.target)) {
                    languageDropdown.classList.remove('show');
                }
            });
            
            languageOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const lang = option.getAttribute('data-lang');
                    updateLanguage(lang);
                    languageDropdown.classList.remove('show');
                    
                    // ä¿å­˜è¯­è¨€åå¥½
                    localStorage.setItem('moonAppLanguage', lang);
                });
            });
            
            // åŠ è½½ä¿å­˜çš„è¯­è¨€åå¥½
            const savedLang = localStorage.getItem('moonAppLanguage');
            if (savedLang && translations[savedLang]) {
                updateLanguage(savedLang);
            }
        }

        // --- æ·»åŠ åŠ¨æ€æ˜Ÿæ˜Ÿæ•ˆæœ ---
        function createStars() {
            const container = document.querySelector('.moon-3d-container');
            for (let i = 0; i < 15; i++) { // å‡å°‘æ˜Ÿæ˜Ÿæ•°é‡
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = Math.random() * 2 + 'px'; // ç¼©å°æ˜Ÿæ˜Ÿ
                star.style.height = star.style.width;
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                star.style.animationDuration = (Math.random() * 3 + 2) + 's';
                container.appendChild(star);
            }
        }

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            initAudio();
            setupLanguageSelector();
            createStars();
            getLocation();
            
            // æ·»åŠ äº¤äº’äº‹ä»¶
            moonContainer.addEventListener('mousedown', handleStart); 
            document.addEventListener('mousemove', handleMove); 
            document.addEventListener('mouseup', handleEnd); 
            moonContainer.addEventListener('touchstart', handleStart); 
            document.addEventListener('touchmove', handleMove); 
            document.addEventListener('touchend', handleEnd);
        };
    </script>
</body>
</html>
